<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>The Angel’s Share — Admin</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#ec7f13",
            "background-light": "#f8f7f6",
            "background-dark": "#221910",
          },
          fontFamily: { display: ["Space Grotesk", "sans-serif"] },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px",
          },
        },
      },
    };
  </script>

  <style>
    .material-symbols-outlined{
      font-variation-settings:'FILL' 0,'wght' 500,'GRAD' 0,'opsz' 24;
    }
    body{font-family:'Space Grotesk',sans-serif; min-height:max(884px,100dvh);}
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen">
  <div class="relative flex h-full min-h-screen w-full flex-col bg-background-light dark:bg-background-dark max-w-[430px] mx-auto shadow-2xl overflow-x-hidden">

    <div class="flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10 border-b border-white/5">
      <a href="/angels-share/" class="text-primary flex size-12 shrink-0 items-center justify-start cursor-pointer" title="Back">
        <span class="material-symbols-outlined">arrow_back_ios</span>
      </a>

      <div class="flex flex-col items-center">
        <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] text-center">Admin</h2>
        <div class="flex items-center gap-1">
          <div id="statusDot" class="size-2 rounded-full bg-gray-500"></div>
          <span id="statusText" class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Not authenticated</span>
        </div>
      </div>

      <div class="flex w-12 items-center justify-end">
        <button id="clearPinBtn" class="flex items-center justify-center rounded-lg h-12 bg-transparent text-white p-0" title="Clear PIN">
          <span class="material-symbols-outlined">key_off</span>
        </button>
      </div>
    </div>

    <div class="px-4 pt-6">
      <h3 class="text-white text-2xl font-bold tracking-tight">Session Controls</h3>
      <p class="text-[#c9ad92] text-sm mt-1">Start, lock, reveal. The Angel’s Share Rule™ does not apply to buttons.</p>
    </div>

    <!-- PIN card -->
    <section class="px-4 pt-5" id="pinSection">
      <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
        <label class="text-primary text-xs font-bold uppercase tracking-wider">Admin PIN</label>
        <input id="pinInput" type="password" placeholder="Enter PIN"
               class="mt-2 w-full bg-black/20 border border-white/10 rounded-lg py-3 px-4 text-white text-sm focus:ring-primary focus:border-primary"/>
        <button id="savePinBtn"
                class="mt-4 w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/20 flex items-center justify-center gap-2 transition-transform active:scale-[0.98]">
          Unlock
          <span class="material-symbols-outlined">lock_open</span>
        </button>
        <p id="pinErr" class="hidden mt-3 text-xs text-red-300 bg-red-950/30 border border-red-400/20 rounded-lg p-3"></p>
      </div>
    </section>

    <!-- Admin actions -->
    <section class="px-4 pt-5 hidden" id="adminSection">
      <div class="rounded-2xl border border-primary/20 bg-white/5 p-5">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-white font-bold">Active Session</p>
            <p class="text-[#c9ad92] text-xs mt-1">ID: <span id="activeId">—</span></p>
            <p class="text-[#c9ad92] text-xs mt-1">Phase: <span id="activePhase" class="text-white/90">—</span></p>
          </div>
          <button id="refreshBtn" class="rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-white px-3 py-2 text-xs font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-[18px]">refresh</span> Refresh
          </button>
        </div>

        <div class="mt-5 grid gap-3">
          <button id="newSessionBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/20 flex items-center justify-center gap-2">
            Start New Session
            <span class="material-symbols-outlined">add_circle</span>
          </button>

          <button id="lockBtn" class="w-full bg-white/10 hover:bg-white/15 border border-white/10 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
            Lock (Generate A/B/C…)
            <span class="material-symbols-outlined">lock</span>
          </button>

          <button id="revealBtn" class="w-full bg-white/10 hover:bg-white/15 border border-white/10 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
            Reveal
            <span class="material-symbols-outlined">visibility</span>
          </button>
        </div>

        <div class="mt-5 rounded-xl border border-white/10 bg-black/20 p-4">
        <p class="text-white text-sm font-bold">Session Tools</p>
        <p class="text-[#c9ad92] text-xs mt-1">Export to JSON, delete one, or purge all test clutter.</p>
      
        <div class="mt-3 flex gap-2">
          <button id="loadSessionsBtn" class="flex-1 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-white px-3 py-2 text-xs font-bold flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-[18px]">list</span> List
          </button>
          <button id="purgeBtn" class="flex-1 rounded-lg bg-red-500/20 hover:bg-red-500/25 border border-red-400/20 text-red-200 px-3 py-2 text-xs font-bold flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-[18px]">delete_sweep</span> Purge
          </button>
        </div>
      
        <label class="block mt-4 text-primary text-xs font-bold uppercase tracking-wider">Past sessions</label>
        <div class="relative mt-2">
          <select id="sessionsSelect" class="w-full bg-black/20 border border-white/10 rounded-lg py-3 px-4 text-white text-sm focus:ring-primary focus:border-primary appearance-none">
            <option value="">(Load list…)</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-white">
            <span class="material-symbols-outlined">expand_more</span>
          </div>
        </div>
      
        <div class="mt-3 flex gap-2">
          <button id="exportBtn" class="flex-1 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-white px-3 py-2 text-xs font-bold flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-[18px]">download</span> Export
          </button>
          <button id="deleteBtn" class="flex-1 rounded-lg bg-red-500/20 hover:bg-red-500/25 border border-red-400/20 text-red-200 px-3 py-2 text-xs font-bold flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-[18px]">delete</span> Delete
          </button>
        </div>
      
        <p class="text-[#c9ad92] text-[11px] mt-3">
          Purge deletes all session blobs (and clears the active session). Export downloads JSON for the selected session.
        </p>
      </div>

        <p id="adminOk" class="hidden mt-4 text-xs text-emerald-200 bg-emerald-950/25 border border-emerald-400/15 rounded-lg p-3"></p>
        <p id="adminErr" class="hidden mt-4 text-xs text-red-300 bg-red-950/30 border border-red-400/20 rounded-lg p-3"></p>

        <div class="mt-5 rounded-xl border border-white/10 bg-black/20 p-4">
          <p class="text-white text-sm font-bold">Host flow</p>
          <ol class="mt-2 text-[#c9ad92] text-xs list-decimal list-inside space-y-1">
            <li>Start session (everyone joins + pre-ranks).</li>
            <li>Right before pours: Lock.</li>
            <li>After tasting + votes: Reveal.</li>
          </ol>
          <p class="mt-3 text-[#c9ad92] text-xs">
            If you see a 409, it usually means “wrong phase” (e.g. already locked).
          </p>
        </div>
      </div>
    </section>

  </div>

<script>
  const API = "https://api.linezforge.com";
  const PIN_KEY = "angelsShare:adminPin";

  const $ = (id) => document.getElementById(id);

  const statusDot = $("statusDot");
  const statusText = $("statusText");

  const pinSection = $("pinSection");
  const adminSection = $("adminSection");

  const pinInput = $("pinInput");
  const savePinBtn = $("savePinBtn");
  const clearPinBtn = $("clearPinBtn");
  const pinErr = $("pinErr");

  const refreshBtn = $("refreshBtn");
  const newSessionBtn = $("newSessionBtn");
  const lockBtn = $("lockBtn");
  const revealBtn = $("revealBtn");

  const activeId = $("activeId");
  const activePhase = $("activePhase");

  const adminOk = $("adminOk");
  const adminErr = $("adminErr");

  const loadSessionsBtn = $("loadSessionsBtn");
  const sessionsSelect = $("sessionsSelect");
  const exportBtn = $("exportBtn");
  const deleteBtn = $("deleteBtn");
  const purgeBtn = $("purgeBtn");

  let adminPin = sessionStorage.getItem(PIN_KEY) || "";
  let lastKnownPhase = null;

  function setStatus(ok, msg) {
    statusText.textContent = msg;
    if (ok) {
      statusDot.className = "size-2 rounded-full bg-primary animate-pulse";
      statusText.className = "text-[10px] uppercase tracking-widest text-primary font-bold";
    } else {
      statusDot.className = "size-2 rounded-full bg-gray-500";
      statusText.className = "text-[10px] uppercase tracking-widest text-gray-400 font-bold";
    }
  }

  async function api(path, opts = {}) {
    const res = await fetch(`${API}${path}`, {
      headers: {
        "Content-Type": "application/json",
        ...(opts.headers || {}),
      },
      ...opts,
    });

    const bodyText = await res.text();
    if (!res.ok) {
      // keep server text, but make 409 readable
      if (res.status === 409) throw new Error(`409 (Wrong phase): ${bodyText}`);
      throw new Error(`${res.status}: ${bodyText}`);
    }

    // try parse json
    try { return JSON.parse(bodyText); } catch { return bodyText; }
  }

  function showMsg(ok, text) {
    adminOk.classList.add("hidden");
    adminErr.classList.add("hidden");
    if (!text) return;
    if (ok) {
      adminOk.textContent = text;
      adminOk.classList.remove("hidden");
    } else {
      adminErr.textContent = text;
      adminErr.classList.remove("hidden");
    }
  }

  function setButtonsForPhase(phase) {
    // disable buttons according to phase to avoid 409 spam
    if (!phase) {
      lockBtn.disabled = true;
      revealBtn.disabled = true;
      lockBtn.classList.add("opacity-60", "cursor-not-allowed");
      revealBtn.classList.add("opacity-60", "cursor-not-allowed");
      return;
    }

    // reset
    [lockBtn, revealBtn].forEach(b => b.classList.remove("opacity-60", "cursor-not-allowed"));
    lockBtn.disabled = false;
    revealBtn.disabled = false;

    if (phase === "OPEN") {
      lockBtn.disabled = false;
      revealBtn.disabled = true;
      revealBtn.classList.add("opacity-60", "cursor-not-allowed");
    } else if (phase === "LOCKED") {
      lockBtn.disabled = true;
      lockBtn.classList.add("opacity-60", "cursor-not-allowed");
      revealBtn.disabled = false;
    } else if (phase === "REVEALED") {
      lockBtn.disabled = true;
      revealBtn.disabled = true;
      lockBtn.classList.add("opacity-60", "cursor-not-allowed");
      revealBtn.classList.add("opacity-60", "cursor-not-allowed");
    }
  }

  async function refresh() {
    showMsg(true, "");
    try {
      const data = await api("/api/active", { method: "GET" });
      if (!data || !data.active) {
        activeId.textContent = "—";
        activePhase.textContent = "—";
        lastKnownPhase = null;
        setButtonsForPhase(null);
        showMsg(false, "No active session. Start a new one.");
        return;
      }
      activeId.textContent = data.active;
      activePhase.textContent = data.phase || "—";
      lastKnownPhase = data.phase || null;
      setButtonsForPhase(lastKnownPhase);
    } catch (e) {
      showMsg(false, String(e.message || e));
    }
  }

  async function loadSessionsList() {
  showMsg(true, "");
  try {
    const data = await api("/api/admin/sessions", {
      method: "GET",
      headers: { "X-Admin-Pin": adminPin }
    });

    const sessions = (data.sessions || []);
    sessionsSelect.innerHTML = `<option value="">(Select…)</option>` + sessions.map(id =>
      `<option value="${id}">${id}</option>`
    ).join("");

    showMsg(true, `Loaded ${sessions.length} session(s).`);
  } catch (e) {
    showMsg(false, String(e.message || e));
  }
}

loadSessionsBtn.addEventListener("click", loadSessionsList);

exportBtn.addEventListener("click", () => {
  const id = sessionsSelect.value;
  if (!id) return showMsg(false, "Pick a session first.");
  // Use a direct navigation so browser downloads it
  const u = `${API}/api/admin/session/export?id=${encodeURIComponent(id)}`;
  fetch(u, { headers: { "X-Admin-Pin": adminPin } })
    .then(async (r) => {
      if (!r.ok) throw new Error(await r.text());
      const blob = await r.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `angels-share-session-${id}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    })
    .catch(e => showMsg(false, String(e.message || e)));
});

deleteBtn.addEventListener("click", async () => {
  const id = sessionsSelect.value;
  if (!id) return showMsg(false, "Pick a session first.");
  if (!confirm(`Delete session ${id}?`)) return;

  showMsg(true, "");
  try {
    await api("/api/admin/session/delete", {
      method: "POST",
      headers: { "X-Admin-Pin": adminPin },
      body: JSON.stringify({ id })
    });
    showMsg(true, `Deleted session ${id}.`);
    await loadSessionsList();
    await refresh();
  } catch (e) {
    showMsg(false, String(e.message || e));
  }
});

purgeBtn.addEventListener("click", async () => {
  if (!confirm("Purge ALL sessions (and clear active)? This is irreversible.")) return;

  showMsg(true, "");
  try {
    const out = await api("/api/admin/sessions/purge", {
      method: "POST",
      headers: { "X-Admin-Pin": adminPin }
    });
    showMsg(true, `Purged ${out.deletedCount} session(s).`);
    sessionsSelect.innerHTML = `<option value="">(Load list…)</option>`;
    await refresh();
  } catch (e) {
    showMsg(false, String(e.message || e));
  }
});

  function unlockUI() {
    pinErr.classList.add("hidden");
    pinSection.classList.add("hidden");
    adminSection.classList.remove("hidden");
    setStatus(true, "Authenticated");
    refresh();
  }

  function lockUI() {
    adminSection.classList.add("hidden");
    pinSection.classList.remove("hidden");
    setStatus(false, "Not authenticated");
    showMsg(true, "");
  }

  savePinBtn.addEventListener("click", () => {
    const pin = (pinInput.value || "").trim();
    if (!pin) {
      pinErr.textContent = "PIN required.";
      pinErr.classList.remove("hidden");
      return;
    }
    adminPin = pin;
    sessionStorage.setItem(PIN_KEY, adminPin);
    unlockUI();
  });

  clearPinBtn.addEventListener("click", () => {
    adminPin = "";
    sessionStorage.removeItem(PIN_KEY);
    pinInput.value = "";
    lockUI();
  });

  refreshBtn.addEventListener("click", refresh);

  newSessionBtn.addEventListener("click", async () => {
    showMsg(true, "");
    try {
      await api("/api/admin/session/new", {
        method: "POST",
        headers: { "X-Admin-Pin": adminPin }
      });
      showMsg(true, "New session started. Tell everyone to join + pre-rank.");
      await refresh();
    } catch (e) {
      showMsg(false, String(e.message || e));
    }
  });

  lockBtn.addEventListener("click", async () => {
    showMsg(true, "");
    try {
      await api("/api/admin/session/lock", {
        method: "POST",
        headers: { "X-Admin-Pin": adminPin }
      });
      showMsg(true, "Locked. Lineup generated. Blind tasting is live.");
      await refresh();
    } catch (e) {
      showMsg(false, String(e.message || e));
      await refresh();
    }
  });

  revealBtn.addEventListener("click", async () => {
    showMsg(true, "");
    try {
      await api("/api/admin/session/reveal", {
        method: "POST",
        headers: { "X-Admin-Pin": adminPin }
      });
      showMsg(true, "Revealed. Names + bottles should now show on the session page.");
      await refresh();
    } catch (e) {
      showMsg(false, String(e.message || e));
      await refresh();
    }
  });

  // init
  if (adminPin) {
    unlockUI();
  } else {
    lockUI();
  }

  // Optional: keep phase fresh
  setInterval(() => {
    if (adminPin) refresh();
  }, 5000);
</script>
</body>
</html>
